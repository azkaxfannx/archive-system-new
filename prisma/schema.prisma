// prisma/schema.prisma - UPDATED VERSION
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  name      String
  nip       String    @unique
  password  String
  role      Role      @default(USER)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  archives  Archive[]
}

model Archive {
  id                  String       @id @default(uuid())
  kodeUnit            String?
  indeks              String?
  nomorBerkas         String?
  judulBerkas         String?
  nomorIsiBerkas      String?
  jenisNaskahDinas    String?
  klasifikasi         String?
  nomorSurat          String?
  tanggal             DateTime?
  perihal             String?
  tahun               Int?
  tingkatPerkembangan String?
  kondisi             String?
  lokasiSimpan        String?
  retensiAktif        String?
  keterangan          String?
  entryDate           DateTime
  retentionYears      Int
  status              Status       @default(ACTIVE)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  userId              String
  user                User         @relation(fields: [userId], references: [id])

  peminjaman          Peminjaman[]
  // CHANGED: Remove direct relation, use junction table
  serahTerimaArchives SerahTerimaArchive[]
}

model Peminjaman {
  id                  String    @id @default(uuid())
  nomorSurat          String
  peminjam            String
  keperluan           String
  tanggalPinjam       DateTime
  tanggalHarusKembali DateTime
  tanggalPengembalian DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  archiveId           String
  archive             Archive   @relation(fields: [archiveId], references: [id], onDelete: Cascade)

  @@map("peminjaman")
}

// CHANGED: Removed archiveId from SerahTerima
model SerahTerima {
  id                  String              @id @default(uuid())
  
  // Usulan fields (diisi saat usulan)
  pihakPenyerah       String
  pihakPenerima       String
  nomorBerkas         String              // NEW: Store nomorBerkas for reference
  tanggalUsulan       DateTime            @default(now())
  statusUsulan        StatusUsulan        @default(PENDING)
  
  // Approval fields (diisi setelah diterima)
  nomorBeritaAcara    String?             @unique
  tanggalSerahTerima  DateTime?
  keterangan          String?
  
  // Rejection field
  alasanPenolakan     String?
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // NEW: Many-to-many relation with Archives
  archives            SerahTerimaArchive[]

  @@map("serah_terima")
}

// NEW: Junction table for many-to-many relationship
model SerahTerimaArchive {
  id            String      @id @default(uuid())
  
  serahTerimaId String
  serahTerima   SerahTerima @relation(fields: [serahTerimaId], references: [id], onDelete: Cascade)
  
  archiveId     String
  archive       Archive     @relation(fields: [archiveId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime    @default(now())

  @@unique([serahTerimaId, archiveId])
  @@map("serah_terima_archives")
}

enum StatusUsulan {
  PENDING
  APPROVED
  REJECTED
}

enum Status {
  ACTIVE
  INACTIVE
  DISPOSE_ELIGIBLE
}

enum Role {
  ADMIN
  USER
}